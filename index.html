<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>中野区 シンプル地図ジェネレーター</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans JP', sans-serif; }
        /* 左側のコントロールパネルの高さを固定し、スクロール可能にする */
        #control-panel {
            height: 100%; /* 親要素の高さに合わせる */
            max-height: 100vh; /* 画面の高さを超えないようにする */
            overflow-y: auto; /* 縦スクロールを有効にする */
        }
        #map-container {
            /* 透明時のチェック柄（表示用のみ） */
            background-image: linear-gradient(45deg, #f0f0f0 25%, transparent 25%, transparent 75%, #f0f0f0 75%, #f0f0f0),
            linear-gradient(45deg, #f0f0f0 25%, transparent 25%, transparent 75%, #f0f0f0 75%, #f0f0f0);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
        }
        .station-label {
            font-size: 11px;
            font-weight: bold;
            text-shadow: 0px 0px 3px rgba(255,255,255,0.9), 0px 0px 2px rgba(255,255,255,1);
            pointer-events: none;
            fill: #333;
        }
        .landmark-label {
            font-size: 10px;
            font-weight: normal;
            text-shadow: 0px 0px 3px rgba(255,255,255,0.9);
            pointer-events: none;
            fill: #444;
        }
        /* UI Customization */
        input[type=range] {
            height: 4px;
            background: #ddd;
            border-radius: 2px;
        }
        .color-input-group {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 4px;
        }
        .color-input-group label {
            font-size: 11px;
            color: #555;
        }
        .color-input-group input {
            width: 30px;
            height: 20px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 h-screen flex flex-col lg:flex-row overflow-hidden">

    <!-- 左側：コントロールパネル -->
    <div id="control-panel" class="w-full lg:w-1/3 p-5 bg-white shadow-lg z-10 scrollbar-thin">
        <h1 class="text-xl font-bold mb-1 text-gray-800">中野区 地図作成ツール</h1>
        <p class="text-xs text-gray-500 mb-4">パンフレット用・沿線＆施設強調版</p>

        <div class="space-y-4">
            <!-- 1. 基本設定 -->
            <div class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                <h2 class="text-sm font-bold text-gray-700 mb-2 flex items-center">
                    <span class="w-4 h-4 bg-blue-500 text-white rounded-full flex items-center justify-center text-xs mr-2">1</span>
                    ベース地図
                </h2>
                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <label class="block text-xs font-bold mb-1 text-gray-500">地図の塗り</label>
                        <input type="color" id="fillColor" value="#F3F4F6" class="w-full h-8 cursor-pointer rounded border">
                    </div>
                    <div>
                        <label class="block text-xs font-bold mb-1 text-gray-500">境界線</label>
                        <input type="color" id="strokeColor" value="#CBD5E1" class="w-full h-8 cursor-pointer rounded border">
                    </div>
                    <div class="col-span-2">
                        <label class="block text-xs font-bold mb-1 text-gray-500">背景色</label>
                        <div class="flex items-center">
                            <input type="checkbox" id="transparentBg" class="mr-2 h-4 w-4" checked>
                            <span class="text-xs mr-2">透明</span>
                            <input type="color" id="bgColor" value="#ffffff" class="flex-1 h-6 cursor-pointer rounded border disabled:opacity-30" disabled>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. 交通網設定 (詳細) -->
            <div class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                <h2 class="text-sm font-bold text-gray-700 mb-2 flex items-center">
                    <span class="w-4 h-4 bg-green-500 text-white rounded-full flex items-center justify-center text-xs mr-2">2</span>
                    鉄道路線（色設定）
                </h2>

                <div class="mb-3">
                    <label class="flex items-center text-sm font-bold cursor-pointer mb-2">
                        <input type="checkbox" id="showRailways" class="mr-2 h-4 w-4 text-blue-600" checked>
                        鉄道を表示 (線路デザイン)
                    </label>

                    <div class="pl-2 space-y-1">
                        <div class="color-input-group">
                            <label>JR中央・総武線</label>
                            <input type="color" id="colorJR" value="#FFD400">
                        </div>
                        <div class="color-input-group">
                            <label>西武新宿線</label>
                            <input type="color" id="colorSeibu" value="#69B076">
                        </div>
                        <div class="color-input-group">
                            <label>都営大江戸線</label>
                            <input type="color" id="colorOedo" value="#E6007C">
                        </div>
                        <div class="color-input-group">
                            <label>丸ノ内線・東西線</label>
                            <input type="color" id="colorMetro" value="#F62E36">
                        </div>
                    </div>
                </div>

                <div class="pt-2 border-t border-gray-200">
                    <div class="flex items-center justify-between mb-2">
                        <label class="flex items-center text-sm font-bold cursor-pointer">
                            <input type="checkbox" id="showRoads" class="mr-2 h-4 w-4 text-blue-600" checked>
                            主要道路 (バス通り)
                        </label>
                        <input type="color" id="roadColor" value="#e5e7eb" class="h-5 w-8 p-0 border-0 rounded">
                    </div>
                </div>
            </div>

            <!-- 3. 駅・施設情報 -->
            <div class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                <h2 class="text-sm font-bold text-gray-700 mb-2 flex items-center">
                    <span class="w-4 h-4 bg-orange-500 text-white rounded-full flex items-center justify-center text-xs mr-2">3</span>
                    スポット情報
                </h2>
                <div class="space-y-2">
                    <div class="flex items-center justify-between">
                        <span class="text-xs font-bold text-gray-600">駅名表示</span>
                        <input type="checkbox" id="showStations" class="h-4 w-4" checked>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-xs font-bold text-gray-600">主要地・公園 (★)</span>
                        <input type="checkbox" id="showLandmarks" class="h-4 w-4" checked>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-xs font-bold text-gray-600">ドロップシャドウ</span>
                        <input type="checkbox" id="showShadow" class="h-4 w-4">
                    </div>
                </div>
            </div>

            <!-- 書き出しボタン -->
            <div class="pt-2">
                <div class="flex gap-2">
                    <button id="downloadPng" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 px-3 rounded font-bold transition text-sm flex items-center justify-center gap-2 shadow-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                        PNG保存
                    </button>
                    <button id="downloadSvg" class="flex-1 bg-gray-700 hover:bg-gray-800 text-white py-2 px-3 rounded font-bold transition text-sm flex items-center justify-center gap-2 shadow-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" /></svg>
                        SVG保存
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 右側：プレビューエリア -->
    <div class="w-full lg:w-2/3 relative bg-gray-200 flex items-center justify-center p-4" id="preview-area">
        <div id="map-container" class="relative bg-white shadow-xl border border-gray-300 box-content">
            <!-- SVG will be injected here -->
        </div>
        <div id="loading" class="absolute inset-0 flex items-center justify-center bg-gray-200 z-20">
            <div class="text-xl font-bold text-gray-600 animate-pulse">地図データを生成中...</div>
        </div>
    </div>

    <script>
        // 設定
        const width = 800;
        const height = 800;

        // 主要駅データ
        const stations = [
            { name: "中野", coords: [139.6658, 35.7057] },
            { name: "東中野", coords: [139.6846, 35.7063] },
            { name: "中野坂上", coords: [139.6801, 35.6973] },
            { name: "新井薬師前", coords: [139.6686, 35.7168] },
            { name: "沼袋", coords: [139.6634, 35.7245] },
            { name: "野方", coords: [139.6528, 35.7194] },
            { name: "都立家政", coords: [139.6448, 35.7223] },
            { name: "鷺ノ宮", coords: [139.6394, 35.7230] },
            { name: "中野新橋", coords: [139.6732, 35.6927] },
            { name: "中野富士見町", coords: [139.6651, 35.6913] }
        ];

        // 主要地・ランドマーク
        const landmarks = [
            { name: "中野サンプラザ", coords: [139.664, 35.707] },
            { name: "中野ブロードウェイ", coords: [139.666, 35.709] },
            { name: "中野四季の森公園", coords: [139.660, 35.708] },
            { name: "哲学堂公園", coords: [139.675, 35.723] },
            { name: "平和の森公園", coords: [139.668, 35.713] },
            { name: "もみじ山公園", coords: [139.666, 35.699] },
            { name: "なかのZERO", coords: [139.670, 35.703] }
        ];

        // 路線データ (区分け)
        const railways = [
            // JR中央線・総武線 (黄色)
            { id: "JR", colorKey: "colorJR", points: [[139.620, 35.7050], [139.6658, 35.7057], [139.6846, 35.7063], [139.700, 35.7050]] },

            // 西武新宿線 (緑)
            { id: "Seibu", colorKey: "colorSeibu", points: [[139.620, 35.7235], [139.6394, 35.7230], [139.6448, 35.7223], [139.6528, 35.7194], [139.6634, 35.7245], [139.6686, 35.7168], [139.700, 35.714]] },

            // 丸ノ内線 (赤) - 中野坂上以東
            { id: "Metro", colorKey: "colorMetro", points: [[139.6801, 35.6973], [139.700, 35.694]] },
             // 丸ノ内線 (赤) - 分岐線
            { id: "Metro", colorKey: "colorMetro", points: [[139.660, 35.695], [139.6651, 35.6913], [139.6732, 35.6927], [139.6801, 35.6973]] },
            // 東西線 (赤/Metro枠で処理) - 中野～落合あたり
            { id: "Metro", colorKey: "colorMetro", points: [[139.6658, 35.7057], [139.675, 35.710], [139.690, 35.712]] },

            // 大江戸線 (ピンク)
            { id: "Oedo", colorKey: "colorOedo", points: [[139.680, 35.730], [139.680, 35.710], [139.6846, 35.7063], [139.6801, 35.6973], [139.682, 35.685]] }
        ];

        const roads = [
            { name: "Kannana", points: [[139.6528, 35.740], [139.6528, 35.7194], [139.655, 35.700], [139.650, 35.680]] },
            { name: "Yamate", points: [[139.683, 35.740], [139.6846, 35.7063], [139.6801, 35.6973], [139.682, 35.680]] },
            { name: "Waseda", points: [[139.620, 35.715], [139.6658, 35.709], [139.700, 35.710]] },
            { name: "Ome", points: [[139.620, 35.698], [139.665, 35.696], [139.6801, 35.6973], [139.700, 35.693]] },
            { name: "NakanoDori", points: [[139.665, 35.730], [139.6658, 35.7057], [139.668, 35.680]] }
        ];

        // DOM要素
        const container = d3.select("#map-container");
        const svg = container.append("svg")
            .attr("xmlns", "http://www.w3.org/2000/svg") // 確実にSVG名前空間を追加
            .attr("width", width)
            .attr("height", height)
            .attr("viewBox", `0 0 ${width} ${height}`)
            .style("background-color", "transparent");

        // フィルター定義
        const defs = svg.append("defs");
        const filter = defs.append("filter")
            .attr("id", "drop-shadow")
            .attr("height", "130%");
        filter.append("feGaussianBlur")
            .attr("in", "SourceAlpha")
            .attr("stdDeviation", 2)
            .attr("result", "blur");
        filter.append("feOffset")
            .attr("in", "blur")
            .attr("dx", 1)
            .attr("dy", 1)
            .attr("result", "offsetBlur");
        const feMerge = filter.append("feMerge");
        feMerge.append("feMergeNode").attr("in", "offsetBlur");
        feMerge.append("feMergeNode").attr("in", "SourceGraphic");

        // レイヤー (順序重要: 背景 -> マップ -> 道路 -> 鉄道 -> 駅 -> ランドマーク)
        const bgLayer = svg.append("g").attr("id", "bg-layer"); // 背景用レイヤー追加
        const mapLayer = svg.append("g").attr("id", "map-layer");
        const roadLayer = svg.append("g").attr("id", "road-layer");
        const railLayer = svg.append("g").attr("id", "rail-layer");
        const stationLayer = svg.append("g").attr("id", "station-layer");
        const landmarkLayer = svg.append("g").attr("id", "landmark-layer");

        const geoJsonUrl = 'https://raw.githubusercontent.com/niiyz/JapanCityGeoJson/master/geojson/13/13114.json';
        let geoData = null;
        let projection = null;
        let pathGenerator = null;

        d3.json(geoJsonUrl).then(data => {
            geoData = data;
            document.getElementById('loading').style.display = 'none';
            renderMap();
        }).catch(err => {
            console.error(err);
            document.getElementById('loading').innerHTML = "エラーが発生しました。";
        });

        function renderMap() {
            if (!geoData) return;

            projection = d3.geoMercator().fitSize([width * 0.9, height * 0.9], geoData);
            pathGenerator = d3.geoPath().projection(projection);

            // クリッピングパス
            defs.select("#nakano-clip").remove();
            defs.append("clipPath")
                .attr("id", "nakano-clip")
                .append("path")
                .datum(geoData.features[0])
                .attr("d", pathGenerator);

            updateStyle();
        }

        function updateStyle() {
            if (!geoData) return;

            const fillColor = document.getElementById('fillColor').value;
            const strokeColor = document.getElementById('strokeColor').value;
            const strokeWidth = 1.5; // 固定化してシンプルに
            const bgColor = document.getElementById('bgColor').value;
            const isTransparent = document.getElementById('transparentBg').checked;

            const showShadow = document.getElementById('showShadow').checked;
            const showStations = document.getElementById('showStations').checked;
            const showLandmarks = document.getElementById('showLandmarks').checked;
            const showRailways = document.getElementById('showRailways').checked;
            const showRoads = document.getElementById('showRoads').checked;
            const roadColor = document.getElementById('roadColor').value;

            // 背景処理: CSSではなくSVG内のRectとして描画することでSVGエクスポートに対応
            document.getElementById('bgColor').disabled = isTransparent;
            bgLayer.selectAll("*").remove();
            if (!isTransparent) {
                bgLayer.append("rect")
                    .attr("width", width)
                    .attr("height", height)
                    .attr("fill", bgColor);
            }

            // 1. ベース地図
            const mapPaths = mapLayer.selectAll("path").data(geoData.features);
            mapPaths.enter().append("path")
                .merge(mapPaths)
                .attr("d", pathGenerator)
                .attr("fill", fillColor)
                .attr("stroke", strokeColor)
                .attr("stroke-width", strokeWidth)
                .style("filter", showShadow ? "url(#drop-shadow)" : null);

            // 2. 道路
            roadLayer.selectAll("*").remove();
            if (showRoads) {
                const lineGen = d3.line()
                    .x(p => projection(p)[0])
                    .y(p => projection(p)[1])
                    .curve(d3.curveCatmullRom.alpha(0.5));

                roadLayer.attr("clip-path", "url(#nakano-clip)")
                    .selectAll("path")
                    .data(roads)
                    .enter()
                    .append("path")
                    .attr("d", d => lineGen(d.points))
                    .attr("fill", "none")
                    .attr("stroke", roadColor)
                    .attr("stroke-width", 7)
                    .attr("stroke-opacity", 0.7);
            }

            // 3. 鉄道 (2重線で線路らしさを表現)
            railLayer.selectAll("*").remove();
            if (showRailways) {
                const lineGen = d3.line()
                    .x(p => projection(p)[0])
                    .y(p => projection(p)[1])
                    .curve(d3.curveLinear);

                const group = railLayer.attr("clip-path", "url(#nakano-clip)").append("g");

                railways.forEach(rail => {
                    const color = document.getElementById(rail.colorKey).value;

                    // 下地（色付き太線）
                    group.append("path")
                        .datum(rail)
                        .attr("d", d => lineGen(d.points))
                        .attr("fill", "none")
                        .attr("stroke", color)
                        .attr("stroke-width", 5)
                        .attr("stroke-linecap", "round");

                    // 上地（白の破線）
                    group.append("path")
                        .datum(rail)
                        .attr("d", d => lineGen(d.points))
                        .attr("fill", "none")
                        .attr("stroke", "white")
                        .attr("stroke-width", 2)
                        .attr("stroke-dasharray", "4,3") // 破線パターン
                        .attr("stroke-linecap", "butt")
                        .style("opacity", 0.8);
                });
            }

            // 4. 駅
            stationLayer.selectAll("*").remove();
            if (showStations) {
                // ラベル背景(白フチ)
                stationLayer.selectAll(".label-bg")
                    .data(stations)
                    .enter()
                    .append("text")
                    .attr("x", d => projection(d.coords)[0])
                    .attr("y", d => projection(d.coords)[1] - 10)
                    .attr("text-anchor", "middle")
                    .attr("class", "station-label")
                    .attr("stroke", "white")
                    .attr("stroke-width", 3)
                    .attr("stroke-opacity", 0.8)
                    .text(d => d.name);

                // ラベル文字
                stationLayer.selectAll(".label-text")
                    .data(stations)
                    .enter()
                    .append("text")
                    .attr("x", d => projection(d.coords)[0])
                    .attr("y", d => projection(d.coords)[1] - 10)
                    .attr("text-anchor", "middle")
                    .attr("class", "station-label")
                    .text(d => d.name);

                // 駅マーカー
                stationLayer.selectAll("circle")
                    .data(stations)
                    .enter()
                    .append("circle")
                    .attr("cx", d => projection(d.coords)[0])
                    .attr("cy", d => projection(d.coords)[1])
                    .attr("r", 4)
                    .attr("fill", "white")
                    .attr("stroke", "#333")
                    .attr("stroke-width", 2);
            }

            // 5. ランドマーク
            landmarkLayer.selectAll("*").remove();
            if (showLandmarks) {
                const lg = landmarkLayer.append("g");

                // アイコン(★)
                lg.selectAll(".landmark-icon")
                    .data(landmarks)
                    .enter()
                    .append("text")
                    .attr("x", d => projection(d.coords)[0])
                    .attr("y", d => projection(d.coords)[1])
                    .attr("text-anchor", "middle")
                    .attr("dominant-baseline", "central")
                    .attr("fill", "#eab308") // Yellow-500
                    .attr("font-size", "14px")
                    .style("text-shadow", "0px 1px 2px rgba(0,0,0,0.2)")
                    .text("★");

                // ラベル
                lg.selectAll(".landmark-text")
                    .data(landmarks)
                    .enter()
                    .append("text")
                    .attr("x", d => projection(d.coords)[0])
                    .attr("y", d => projection(d.coords)[1] + 12)
                    .attr("text-anchor", "middle")
                    .attr("class", "landmark-label")
                    .text(d => d.name);
            }
        }

        // イベントリスナー
        const inputs = document.querySelectorAll('input');
        inputs.forEach(input => {
            input.addEventListener('input', updateStyle);
            input.addEventListener('change', updateStyle);
        });

        // 保存機能
        document.getElementById('downloadPng').addEventListener('click', () => {
            const svgData = new XMLSerializer().serializeToString(svg.node());
            const canvas = document.createElement("canvas");
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext("2d");
            const img = new Image();
            const svgBlob = new Blob([svgData], { type: "image/svg+xml;charset=utf-8" });
            const url = URL.createObjectURL(svgBlob);

            img.onload = function() {
                // PNGの場合はCanvas上で背景を描画する（透明でない場合）
                if (!document.getElementById('transparentBg').checked) {
                    ctx.fillStyle = document.getElementById('bgColor').value;
                    ctx.fillRect(0, 0, width, height);
                }
                ctx.drawImage(img, 0, 0);
                const a = document.createElement("a");
                a.download = "nakano-map-final.png";
                a.href = canvas.toDataURL("image/png");
                a.click();
                URL.revokeObjectURL(url);
            };
            img.src = url;
        });

        document.getElementById('downloadSvg').addEventListener('click', () => {
            const svgData = new XMLSerializer().serializeToString(svg.node());
            const blob = new Blob([svgData], { type: "image/svg+xml;charset=utf-8" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.download = "nakano-map-final.svg";
            a.href = url;
            a.click();
            URL.revokeObjectURL(url);
        });
    </script>
</body>
</html>
